generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Healthcheck {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
}

enum UserRole {
  OWNER
  RENTER
  ADMIN
}

enum KYCStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  PAYMENT_CONFIRMED
}

enum PaymentMethod {
  CASH
  MPESA
  BANK
}

model User {
  id       String   @id @default(cuid())
  name     String?
  email    String?  @unique
  phone    String   @unique
  role     UserRole
  password String?
  isActive Boolean  @default(true)

  kyc              KYC?
  vehicles         Vehicle[]       @relation("OwnerVehicles")
  bookings         Booking[]       @relation("RenterBookings")
  givenRatings     Rating[]        @relation("RaterRatings")
  receivedRatings  Rating[]        @relation("RatedUserRatings")
  otps             OTP[]
  trustScore       TrustScore?
  auditLogs        AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phone])
  @@index([role])
}

model OTP {
  id        String   @id @default(cuid())
  userId    String
  code      String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
}

model KYC {
  id         String    @id @default(cuid())
  userId     String    @unique
  fullName   String
  nationalId String
  address    String?
  city       String?
  latitude   Float?
  longitude  Float?
  idFrontUrl String?
  idBackUrl  String?
  selfieUrl  String?
  status     KYCStatus @default(PENDING)
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])
}

model Vehicle {
  id           String   @id @default(cuid())
  ownerId      String
  
  // Basic vehicle information
  make         String?
  model        String?
  title        String   // Computed from make + model or provided directly
  year         Int?
  category     String
  
  // Technical specifications
  transmission String?
  fuelType     String?
  seats        Int?
  engineSize   String?
  mileage      Int?
  
  // Pricing
  dailyPrice     Int?
  weeklyDiscount Int?     @default(0)
  monthlyDiscount Int?    @default(0)
  monthlyPrice   Int?     // Legacy field
  
  // Leasing options
  availableForLease Boolean @default(false)
  leaseMinDuration  Int?    // Minimum lease duration in months (6+ only)
  leaseMonthlyPrice Int?    // Monthly lease price
  
  // Location and description
  location     String
  address      String?
  description  String?
  
  // Features and media
  features     String?  // JSON string of features array
  images       String?  // JSON string of image URLs
  documents    String?  // JSON string of document URLs
  
  // Status and availability
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED
  withDriver   Boolean  @default(false)
  isAvailable  Boolean  @default(true)

  owner    User      @relation("OwnerVehicles", fields: [ownerId], references: [id])
  bookings Booking[]
  driver   Driver?
  ratings  Rating[]  @relation("VehicleRatings")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([category])
  @@index([location])
  @@index([status])
}

model Driver {
  id        String  @id @default(cuid())
  vehicleId String  @unique
  name      String
  phone     String
  licenseNo String?

  vehicle      Vehicle       @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  driverLinks  DriverLink[]
  ratings      Rating[]      @relation("DriverRatings")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phone])
}

model DriverLink {
  id        String    @id @default(cuid())
  driverId  String
  bookingId String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  driver  Driver  @relation(fields: [driverId], references: [id], onDelete: Cascade)
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([token])
  @@index([driverId])
  @@index([bookingId])
}

model Booking {
  id         String        @id @default(cuid())
  renterId   String
  vehicleId  String
  ownerId    String
  status     BookingStatus @default(PENDING)
  startDate  DateTime
  endDate    DateTime
  totalPrice Int
  
  // Driver and timing information
  pickupTime      String?
  returnTime      String?
  driverName      String?
  driverPhone     String?
  driverLicense   String?
  specialRequests String?
  
  // Delivery information
  needsDelivery    Boolean @default(false)
  pickupLocation   String? // JSON string
  dropoffLocation  String? // JSON string

  renter       User         @relation("RenterBookings", fields: [renterId], references: [id])
  vehicle      Vehicle      @relation(fields: [vehicleId], references: [id])
  payment      Payment?
  driverLinks  DriverLink[]
  ratings      Rating[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([renterId])
  @@index([vehicleId])
  @@index([ownerId])
  @@index([status])
}

model Payment {
  id          String         @id @default(cuid())
  bookingId   String         @unique
  amount      Int?
  method      PaymentMethod?
  received    Boolean        @default(false)
  confirmedAt DateTime?
  confirmedBy String?

  booking   Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  auditLogs AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RatingType {
  VEHICLE
  OWNER
  DRIVER
}

model Rating {
  id         String     @id @default(cuid())
  bookingId  String
  raterId    String
  ratedType  RatingType
  vehicleId  String?
  driverId   String?
  ratedUserId String?
  score      Int
  comment    String?

  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  rater      User     @relation("RaterRatings", fields: [raterId], references: [id])
  vehicle    Vehicle? @relation("VehicleRatings", fields: [vehicleId], references: [id])
  driver     Driver?  @relation("DriverRatings", fields: [driverId], references: [id])
  ratedUser  User?    @relation("RatedUserRatings", fields: [ratedUserId], references: [id])

  createdAt DateTime @default(now())

  @@index([bookingId])
  @@index([raterId])
  @@index([vehicleId])
  @@index([driverId])
  @@index([ratedUserId])
}

model TrustScore {
  id                  String  @id @default(cuid())
  userId              String  @unique
  score               Float   @default(0)
  kycCompleted        Boolean @default(false)
  completionRate      Float   @default(0)
  paymentAccuracy     Float   @default(0)
  averageRating       Float   @default(0)
  disputeCount        Int     @default(0)
  adminOverride       Float?
  adminOverrideReason String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

enum AuditAction {
  KYC_APPROVED
  KYC_REJECTED
  PAYMENT_CONFIRMED
  PAYMENT_UPDATED
  USER_FLAGGED
  TRUST_SCORE_OVERRIDE
  BOOKING_CANCELLED
}

model AuditLog {
  id          String      @id @default(cuid())
  action      AuditAction
  performedBy String
  targetId    String
  targetType  String
  paymentId   String?
  details     Json?

  user    User     @relation(fields: [performedBy], references: [id])
  payment Payment? @relation(fields: [paymentId], references: [id])

  createdAt DateTime @default(now())

  @@index([performedBy])
  @@index([targetId])
  @@index([action])
}
